<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS Ecommerce App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="https://via.placeholder.com/16" />
    <link rel="stylesheet" href="styles.css">
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <header class="bg-primary text-white p-3 mb-4 sticky-top">
      <div class="container d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0"><i class="fas fa-store me-2"></i>Ecommerce Demo</h1>
        <button class="btn btn-light dark-mode-toggle" aria-label="Toggle dark mode"><i class="fas fa-moon"></i></button>
      </div>
    </header>

    <section class="hero text-center py-5 bg-light mb-4">
      <div class="container">
        <h2 class="display-6 fw-normal">Welcome to our demo store</h2>
        <p>Browse products, add your own, and chat with our assistant.</p>
      </div>
    </section>

    <div id="root" class="container"></div>
    <footer class="text-white">
      &copy; 2025 My Shop
    </footer>
    <script type="text/babel">
      const currency = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
      const App = () => {
        const [products, setProducts] = React.useState([]);
        const [loadingProducts, setLoadingProducts] = React.useState(true);
        const [page, setPage] = React.useState(1);
        const perPage = 5;
        const [total, setTotal] = React.useState(0);
        const [name, setName] = React.useState('');
        const [price, setPrice] = React.useState('');
        const [messages, setMessages] = React.useState([]);
        const [userMessage, setUserMessage] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState('');
        const [success, setSuccess] = React.useState('');

        React.useEffect(() => {
          setLoadingProducts(true);
          fetch(`/products?page=${page}&per_page=${perPage}`)
            .then(res => res.json())
            .then(data => {
              setProducts(data.items);
              setTotal(data.total);
            })
            .finally(() => setLoadingProducts(false));
        }, [page]);

        React.useEffect(() => {
          fetch('/chat/history')
            .then(res => res.json())
            .then(hist => setMessages(hist));
        }, []);

        const validProduct = () => name.trim() && !isNaN(parseFloat(price)) && parseFloat(price) >= 0;

        const addProduct = () => {
          if (!validProduct()) {
            setError('Valid name and price required');
            return;
          }
          setError('');
          fetch('/products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, price: parseFloat(price) })
          })
            .then(res => res.json())
            .then(() => {
              // refresh current page after adding
              fetch(`/products?page=${page}&per_page=${perPage}`)
                .then(res => res.json())
                .then(data => {
                  setProducts(data.items);
                  setTotal(data.total);
                });
              setName('');
              setPrice('');
              setSuccess('Product added!');
              setTimeout(() => setSuccess(''), 2000);
            });
        };

        const sendMessage = () => {
          if (!userMessage.trim()) return;
          setLoading(true);
          fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage })
          })
            .then(res => res.json())
            .then(data => {
              setMessages([...messages, { user: userMessage, bot: data.response }]);
              setUserMessage('');
            })
            .finally(() => setLoading(false));
        };

        return (
          <div className="row g-4">
            <div className="col-md-4">
              <h2>Products</h2>
              <div className="row row-cols-1 g-3">
                {loadingProducts && (
                  <div className="col">
                    <div className="card h-100 shadow-sm p-3 placeholder-glow">
                      <div className="placeholder card-img-top mb-2"></div>
                      <span className="placeholder col-6"></span>
                    </div>
                  </div>
                )}
                {products.map(p => (
                  <div key={p.id} className="col">
                    <div className="card h-100 shadow-sm product-card">
                      <img className="card-img-top" src="https://via.placeholder.com/150" alt="" />
                      <div className="card-body">
                        <h5 className="card-title text-center">{p.name}</h5>
                        <p className="card-text text-center">{currency.format(p.price)}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              <nav className="mt-3" aria-label="Product pages">
                <ul className="pagination justify-content-center">
                  <li className="page-item">
                    <button className="page-link" onClick={() => setPage(page - 1)} disabled={page <= 1}>Prev</button>
                  </li>
                  <li className="page-item disabled"><span className="page-link">Page {page}</span></li>
                  <li className="page-item">
                    <button className="page-link" onClick={() => setPage(page + 1)} disabled={page >= Math.ceil(total / perPage)}>Next</button>
                  </li>
                </ul>
              </nav>
            </div>
            <div className="col-md-4">
              <h2>Add Product</h2>
              <div className="mb-3">
                <label className="form-label" htmlFor="name">Name</label>
                <input id="name" className="form-control" placeholder="Product name" value={name} onChange={e => setName(e.target.value)} aria-required="true" />
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="price">Price</label>
                <input id="price" className="form-control" placeholder="0.00" value={price} onChange={e => setPrice(e.target.value)} aria-required="true" />
              </div>
              {error && <div className="text-danger mb-2">{error}</div>}
              {success && <div className="text-success mb-2">{success}</div>}
              <button className="btn btn-primary" onClick={addProduct} disabled={!validProduct()} data-bs-toggle="tooltip" title="Add product">
                <i className="fas fa-plus me-1"></i>Add
              </button>
            </div>
            <div className="col-md-4">
              <h2>Chatbot Assistant</h2>
              <div className="mb-3" style={{ maxHeight: '300px', overflowY: 'auto' }} role="log" aria-live="polite">
                {messages.map((m, i) => (
                  <div key={i} className="chat-message d-flex gap-2">
                    <i className="fas fa-user-circle text-primary"></i>
                    <div>
                      <div><strong>You:</strong> {m.user}</div>
                      <div className="d-flex align-items-start gap-2"><i className="fas fa-robot text-success"></i><span>{m.bot}</span></div>
                    </div>
                  </div>
                ))}
                {loading && <div className="loading">Bot is typing...</div>}
              </div>
              <div className="input-group">
                <input className="form-control" placeholder="Type a message" value={userMessage} onChange={e => setUserMessage(e.target.value)} onKeyDown={e => { if (e.key === 'Enter') sendMessage(); }} aria-label="Message" />
                <button className="btn btn-secondary" onClick={sendMessage} disabled={!userMessage.trim()} aria-label="Send" data-bs-toggle="tooltip" title="Send message">
                  <i className="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        );
      };

      React.useEffect(() => {
        document.querySelector('.dark-mode-toggle').addEventListener('click', () => {
          document.body.classList.toggle('dark');
        });
        const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(t => new bootstrap.Tooltip(t));
      }, []);

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
